#!/usr/bin/env bash

trap "kill -- -$$" SIGINT SIGTERM EXIT

function desktops() {
    focused=$(bspc query -D -d focused --names)

    echo -n "%{F-B-}"

    for desktop in $(bspc query -D --names); do
        echo -n "%{A:bspc desktop -f $desktop:}"

        if [[ "$desktop" = "$focused" ]]; then
            echo -n " %{F-B-R}$desktop%{F-B-}"
        else
            echo -n " $desktop"
        fi

        echo -n "%{A}"
    done
}

desktops_file=/tmp/lemonbar$$

desktops > "$desktops_file"

bspc subscribe desktop | while read line; do
    if [[ $(echo "$line" | cut -f1 -d' ') = desktop_focus ]]; then
        desktops > "$desktops_file"
    fi
done &

while :; do
    echo "%{l}$(cat "$desktops_file") %{c}$(xtitle) %{r}$(date +%T)"
    sleep 0.1
done | lemonbar -f "Hack:size=10" | bash
