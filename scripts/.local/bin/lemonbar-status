#!/usr/bin/env bash

trap "kill -- -$$" SIGINT SIGTERM EXIT

function desktops() {
    focused=$(bspc query -D -d focused --names)

    echo -n "%{F-B-}"

    for desktop in $(bspc query -D --names); do
        echo -n "%{A:bspc desktop -f $desktop:}"

        if [[ "$desktop" = "$focused" ]]; then
            echo -n " %{F-B-R}$desktop%{F-B-}"
        else
            echo -n " $desktop"
        fi

        echo -n "%{A}"
    done
}

while :; do
    desktops=$(desktops)
    title=$(xtitle)
    mem_usage_b=$(free -t | tr -s ' ' | cut -d' ' -f3 | sed -n '$p')
    mem_usage_gb=$(echo "scale = 2; $mem_usage_b / 1024^2" | bc -l)
    time=$(date +%T)

    echo "%{l}$desktops%{c}$title%{r}${mem_usage_gb}G | $time"

    sleep 0.1
done | lemonbar -f "Hack:size=10" | bash
