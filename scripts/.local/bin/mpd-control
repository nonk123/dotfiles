#!/bin/bash

host=185.222.117.80
port=6600

http="https://mpd.nonk.users.as205315.net"

function _mpc {
    mpc --host=$host --port=$port "$@"
}

mpc playlist | grep $http > /dev/null || mpc add $http
_mpc repeat on > /dev/null &

function self {
    command=$1
    shift

    case "$command" in
    play)
        if [ $# -eq 0 ]; then
            mpc stop; mpc play
            notify-send "Playing"
        else
            _mpc stop; _mpc clear
            self queue "$@"
            self play
        fi
        ;;
    prompt)
        _mpc listall | prompt "Select a track"
        ;;
    select)
        result=$(self prompt)
        [ "$result" ] && self play "$result"
        ;;
    queue)
        if [ $# -eq 0 ]; then
            result=$(self prompt)
        else
            result=$(for track in "$@"; do echo "$track"; done)
        fi

        if [ "$result" ]; then
            echo "$result" | while read track; do
                _mpc search filename "$track" | _mpc add
            done

            _mpc play
        fi
        ;;
    toggle)
        _mpc | grep "^\[playing]" && self pause || self resume
        ;;
    pause)
        _mpc pause
        mpc stop
        notify-send "Paused"
        ;;
    resume)
        _mpc play
        mpc play
        notify-send "Resumed"
        ;;
    status)
        status=$(_mpc status)
        notify-send "Status" "$status"
        echo "$status"
        ;;
    http)
        echo "$http"
        ;;
    next|prev|single)
        _mpc "$command" && self status
        ;;
    download)
        if [ $# -eq 1 ]; then
            if ssh -T "music@$host" << EOF
youtube-dl --no-playlist -o "~/music/%(title)s.%(ext)s" -x "$1" && mpc update
EOF
            then
                notify-send Done "$1"
            else
                notify-send Failed "$1"
            fi
        else
            while read url; do
                self download "$url"
            done
        fi
        ;;
    *)
        _mpc "$@"
        ;;
    esac
}

self "$@"
