#!/bin/bash

user=lsp
host=185.222.117.73
reverse=2000
dest_root=/tmp/
archive_dir=/tmp/

addr=$user@$host

server=$1
project_root=$(realpath ${2:-.})
[ $# -gt 2 ] && shift 2

dest="$dest_root/$(basename $project_root)"

archive_name=transfer.tar
archive=$archive_dir/$archive_name

cd $project_root

function copy {
    ssh $addr mkdir -p $2
    scp -r $1 $addr:$2

    if [ $# -gt 2 ]; then
        shift 2
        for line in "$@"; do
            echo "$line"
        done | ssh $addr bash
    fi
}

function mount {
    archive=/tmp/transfer.tar
    files=$archive.ls

    (git ls-files; git ls-files -o -X "$project_root/.gitignore") > $files
    rm -f $archive
    tar -czf $archive -T $files

    archive_name=$(basename $archive)
    copy $archive $dest "mkdir -p $dest" "cd $dest" "tar -xf $archive_name" "rm $archive_name"

    inotifywait -rm . | while read line; do
        case $(echo "$line" | cut -d\  -f2) in
            MODIFY|CREATE)
                dir=$(echo "$line" | cut -d\  -f1)
                name=$(echo "$line" | cut -d\  -f3)
                copy $dir/$name $dest/$dir/$name
                ;;
        esac
    done
}

exec 3<<EOF
cd $dest
# pyls hack.
export VIRTUAL_ENV=$VIRTUAL_ENV
exec $server $@
EOF

mount & exec cat /proc/$$/fd/{3,0} | ssh -C $addr /bin/bash -l
