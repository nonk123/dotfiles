#!/bin/bash

user=lsp
host=185.222.117.73
reverse=2000

addr=$user@$host

server=$1
project_root=$(realpath ${2:-.})
[ $# -gt 2 ] && shift 2

dest="/tmp/$(basename $project_root)"
archive=/tmp/transfer.tar
env_dir=env/

cd $project_root

function copy {
    ssh $addr mkdir -p $(dirname $2)
    scp -r $1 $addr:$2

    if [ $# -gt 2 ]; then
        shift 2
        for line in "$@"; do
            echo "$line"
        done | ssh $addr bash
    fi
}

function project_ls {
    git ls-files -X .gitignore
    git ls-files -X .gitignore -o
    [ -d $env_dir ] && echo $env_dir
}

function mount {
    rm -f $archive
    tar -czf $archive -T <(project_ls)

    archive_name=$(basename $archive)
    ssh $addr "mkdir -p $dest"
    copy $archive $dest "cd $dest" "tar -xf $archive_name" "rm $archive_name" "echo > .projectile"

    mainloop
}

function mainloop {
    while :; do
        file=$(inotifywait -r -e modify -e create -e moved_to . \
                   | cut -d' '  -f1,3 | sed 's/ //g')
        grep -E '[~#]$' <(basename $file) || copy $file $dest/$file
    done
}

exec 3<<EOF
mkdir -p $dest
cd $dest
[ -d $env_dir ] && export VIRTUAL_ENV=\$(realpath $env_dir)
exec $server $@
EOF

mount &
exec cat /proc/$$/fd/{3,0} | ssh -C $addr /bin/bash -l
